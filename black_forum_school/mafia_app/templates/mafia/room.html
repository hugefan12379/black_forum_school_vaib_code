{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ö–æ–º–Ω–∞—Ç–∞ {{ room.room_number }} ‚Äî –ú–∞—Ñ–∏—è</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>

    #chatInput {
      color: #000 !important;
      background: #fff !important;
    }

    #chatInput::placeholder {
      color: #666 !important;
    }

    body {
      background: radial-gradient(1200px 600px at 20% 0%, #2a3446 0%, #151a22 55%, #0f1218 100%);
      color: #fff;
    }

    .card {
      background: rgba(45, 52, 66, 0.92);
      border: 1px solid rgba(180, 200, 255, 0.18);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      border-radius: 14px;
    }

    /* –í–°–Å –±–µ–ª–æ–µ */
    .muted,
    .chat-time,
    .role-pill,
    .card,
    .card * {
      color: #ffffff !important;
    }

    .badge-phase { font-size: 14px; }

    .player-item {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.10);
    }
    .player-item:last-child { border-bottom:none; }

    .alive { color:#6dff8b !important; font-weight:700; }
    .dead { color:#ff6b6b !important; font-weight:700; }

    .role-pill {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(80, 120, 255, 0.18);
      border: 1px solid rgba(80, 120, 255, 0.35);
    }

    .guide-item {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.16);
      margin-bottom: 10px;
    }

    .guide-title {
      font-weight: 800;
      margin-bottom: 6px;
    }

    .chat-box {
      height: 260px;
      overflow-y: auto;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 12px;
      padding: 10px;
    }

    .chat-line {
      margin-bottom: 6px;
      font-size: 14px;
    }

    .glow {
      box-shadow: 0 0 0 1px rgba(120, 150, 255, 0.15), 0 10px 30px rgba(50, 90, 255, 0.12);
    }
  </style>
</head>

<body>

<div class="container py-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="mb-0">üïµÔ∏è –ö–æ–º–Ω–∞—Ç–∞ {{ room.room_number }}</h3>
      <div class="muted">
        –í–µ–¥—É—â–∏–π: <span id="hostName">‚Äî</span>
      </div>
    </div>

    <div class="text-end">
      <a href="/mafia/" class="btn btn-outline-light btn-sm">‚Üê –ù–∞–∑–∞–¥ –∫ –∫–æ–º–Ω–∞—Ç–∞–º</a>
    </div>
  </div>

  <div class="row g-3">

    <!-- LEFT -->
    <div class="col-lg-7">

      <!-- STATUS -->
      <div class="card p-3 mb-3 glow">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <div class="muted">–°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã</div>
            <div class="mt-1">
              <span id="gameStartedBadge" class="badge bg-secondary">–ò–≥—Ä–∞ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å</span>
              <span id="phaseBadge" class="badge bg-dark badge-phase ms-2">–ª–æ–±–±–∏</span>
            </div>
            <div class="muted mt-1">
              –î–µ–Ω—å: <span id="dayNumber">0</span> ‚Ä¢ –ù–æ—á—å: <span id="nightNumber">0</span>
              <button id="btnDoAction" class="btn btn-dark text-dark">üéØ –î–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å</button>

            </div>
          </div>

          <div class="text-end">
            <div class="muted">–¢–≤–æ—è —Ä–æ–ª—å</div>
            <div id="myRole" class="fw-bold">‚Äî</div>
          </div>
        </div>

        <hr class="border-secondary">

        <div class="d-flex flex-wrap gap-2">
          <button id="btnJoin" class="btn btn-success">–í–æ–π—Ç–∏</button>
          <button id="btnLeave" class="btn btn-danger">–í—ã–π—Ç–∏</button>
          <button id="btnBecomeHost" class="btn btn-warning">–°—Ç–∞—Ç—å –≤–µ–¥—É—â–∏–º</button>
          <button id="btnStartGame" class="btn btn-primary">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
          <button id="btnSetDay" class="btn btn-outline-info">–î–µ–Ω—å</button>
          <button id="btnSetNight" class="btn btn-outline-info">–ù–æ—á—å</button>
        </div>

        <!-- –î–ù–ï–í–ù–û–ï –ì–û–õ–û–°–û–í–ê–ù–ò–ï -->
        <div class="mt-3">
          <div class="d-flex flex-wrap gap-2">
            <button id="btnStartDayVote" class="btn btn-dark">üó≥ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ (–¥–µ–Ω—å)</button>
          </div>
          <div class="mt-2">
            <span class="muted">–î–µ–¥–ª–∞–π–Ω –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:</span>
            <span id="dayVoteDeadlineText">‚Äî</span>
          </div>
        </div>

        <div id="statusText" class="mt-3 muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>

      <div class="mt-2 muted">
        ‚è≥ –¢–∞–π–º–µ—Ä —Ö–æ–¥–∞: <b id="turnTimer">‚Äî</b>
      </div>

      <div class="mt-1 muted">
        üé≠ –°–µ–π—á–∞—Å —Ö–æ–¥–∏—Ç: <b id="turnRoleText">‚Äî</b>
      </div>

      <div class="mt-2 muted">
        üó≥Ô∏è –î–µ–¥–ª–∞–π–Ω –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è: <b id="dayVoteTimer">‚Äî</b>
      </div>

      <!-- PLAYERS -->
      <div class="card p-3 mb-3">
        <h5 class="mb-2">üë• –ò–≥—Ä–æ–∫–∏</h5>
        <div id="playersList" class="mt-2"></div>
        <div class="muted mt-2">
          –í—Å–µ–≥–æ: <span id="playersCount">0</span>
        </div>
      </div>

      <!-- CHAT -->
      <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">üí¨ –ß–∞—Ç</h5>
          <span class="muted" style="font-size: 12px;">(–≤–∏–¥–µ–Ω –¥–Ω—ë–º)</span>
        </div>

        <div id="chatBox" class="chat-box">
          <div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞...</div>
        </div>

        <div class="d-flex gap-2 mt-2">
          <input id="chatInput" class="form-control" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
          <button id="chatSendBtn" class="btn btn-dark">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div id="chatStatus" class="muted mt-2" style="font-size: 12px;"></div>
      </div>

    </div>

    <!-- RIGHT -->
    <div class="col-lg-5">

      <!-- ROLE GUIDES -->
      <div class="card p-3 mb-3">
        <h5 class="mb-2">üìå –ì–∞–π–¥—ã –ø–æ —Ä–æ–ª—è–º</h5>

        <div class="guide-item">
          <div class="guide-title">üôÇ –ú–∏—Ä–Ω—ã–π</div>
          <div class="muted">–ì–æ–ª–æ—Å—É–µ—Ç –¥–Ω—ë–º.</div>
        </div>

        <div class="guide-item">
          <div class="guide-title">üíâ –î–æ–∫—Ç–æ—Ä</div>
          <div class="muted">–ù–æ—á—å—é –ª–µ—á–∏—Ç –∏–≥—Ä–æ–∫–∞.</div>
        </div>

        <div class="guide-item">
          <div class="guide-title">üïµÔ∏è –®–µ—Ä–∏—Ñ</div>
          <div class="muted">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–≥—Ä–æ–∫–∞.</div>
        </div>

        <div class="guide-item">
          <div class="guide-title">üî´ –ú–∞—Ñ–∏—è</div>
          <div class="muted">–ù–æ—á—å—é –≤—ã–±–∏—Ä–∞–µ—Ç –∂–µ—Ä—Ç–≤—É.</div>
        </div>

        <div class="guide-item">
          <div class="guide-title">üíã –ö—Ä–∞—Å–æ—Ç–∫–∞</div>
          <div class="muted">–ù–æ—á—å—é –±–ª–æ–∫–∏—Ä—É–µ—Ç –∏–≥—Ä–æ–∫–∞.</div>
        </div>

        <div class="guide-item">
          <div class="guide-title">üî™ –ú–∞–Ω—å—è–∫</div>
          <div class="muted">–£–±–∏–≤–∞–µ—Ç –Ω–æ—á—å—é.</div>
        </div>
      </div>

      <!-- QUICK HELP -->
      <div class="card p-3">
        <h5 class="mb-2">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏</h5>
        <ul class="muted mb-0">
          <li>–ú–∏–Ω–∏–º—É–º 5 –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞</li>
          <li>–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –≤—ã—Ö–æ–¥ –∑–∞–ø—Ä–µ—â—ë–Ω</li>
          <li>–†–æ–ª–∏ —Å–∫—Ä—ã—Ç—ã (–∫—Ä–æ–º–µ –≤–µ–¥—É—â–µ–≥–æ)</li>
          <li>–ß–∞—Ç –≤–∏–¥–µ–Ω —Ç–æ–ª—å–∫–æ –¥–Ω—ë–º</li>
        </ul>
      </div>

    </div>

  </div>
</div>

<script>
  let selectedTargetId = null;
let selectedMode = null; 
// "night_action" –∏–ª–∏ "day_vote"
  let currentPhase = "lobby";
let myRoleRaw = null;
let myTurnRole = null;
let dayVoteActive = false;

  const ROOM_NUMBER = {{ room.room_number }};
  const PING_URL = `/mafia/room/${ROOM_NUMBER}/ping/`;
  let lastWinnerText = "";

  const STATE_URL = `/mafia/room/${ROOM_NUMBER}/state/`;
  const JOIN_URL = `/mafia/room/${ROOM_NUMBER}/join/`;
  const LEAVE_URL = `/mafia/room/${ROOM_NUMBER}/leave/`;
  const BECOME_HOST_URL = `/mafia/room/${ROOM_NUMBER}/become-host/`;
  const START_URL = `/mafia/room/${ROOM_NUMBER}/start/`;
  const CHAT_LIST_URL = `/mafia/room/${ROOM_NUMBER}/chat/list/`;
  const CHAT_SEND_URL = `/mafia/room/${ROOM_NUMBER}/chat/send/`;
  const PHASE_SET_URL = `/mafia/room/${ROOM_NUMBER}/phase/set/`;

  const DAY_VOTE_START_URL = `/mafia/room/${ROOM_NUMBER}/day-vote/start/`;
  const DAY_VOTE_CAST_URL = `/mafia/room/${ROOM_NUMBER}/day-vote/cast/`;

  

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie("csrftoken");

  async function post(url, formData=null) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: formData
    });
    return await res.json();
  }

  function phaseLabel(phase) {
    if (phase === "lobby") return "–ª–æ–±–±–∏";
    if (phase === "night") return "–Ω–æ—á—å";
    if (phase === "day") return "–¥–µ–Ω—å";
    return phase || "‚Äî";
  }

  function roleLabel(role) {
    if (!role) return "‚Äî";
    const map = {
      "host": "üé§ –í–µ–¥—É—â–∏–π",
      "civil": "üôÇ –ú–∏—Ä–Ω—ã–π",
      "doctor": "üíâ –î–æ–∫—Ç–æ—Ä",
      "sheriff": "üïµÔ∏è –®–µ—Ä–∏—Ñ",
      "mafia": "üî´ –ú–∞—Ñ–∏—è",
      "boss": "üíã –ö—Ä–∞—Å–æ—Ç–∫–∞",
      "maniac": "üî™ –ú–∞–Ω—å—è–∫"
    };
    return map[role] || role;
  }

  function fmtDeadline(iso) {
    if (!iso) return "‚Äî";
    try {
      const d = new Date(iso);
      return d.toLocaleTimeString("ru-RU");
    } catch {
      return "‚Äî";
    }
  }

  function renderPlayers(players) {
  const list = document.getElementById("playersList");
  list.innerHTML = "";

  if (!players || players.length === 0) {
    list.innerHTML = `<div class="muted">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</div>`;
    return;
  }

  players.forEach(p => {
    const row = document.createElement("div");
    row.className = "player-item";

    // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
    if (selectedTargetId === p.id) {
      row.style.background = "rgba(255,255,255,0.12)";
      row.style.borderRadius = "10px";
    }

    const left = document.createElement("div");
    left.innerHTML = `
      <div class="fw-semibold">
        <span title="${p.full_name || p.name}" style="cursor: help;">
          ${p.name}
        </span>
        ${p.is_host ? `<span class="badge bg-warning text-dark ms-2">–í–µ–¥—É—â–∏–π</span>` : ""}
      </div>
      <div class="muted" style="font-size: 13px;">
        ${p.is_alive ? `<span class="alive">–∂–∏–≤</span>` : `<span class="dead">–º—ë—Ä—Ç–≤</span>`}
      </div>
    `;

    const right = document.createElement("div");

    // –≥–æ–ª–æ—Å–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    const votesCount = (window.dayVotes && window.dayVotes[p.id]) ? window.dayVotes[p.id] : 0;
    const votesText = document.createElement("div");
    votesText.style.fontSize = "12px";
    votesText.className = "muted";
    votesText.innerText = `–ì–æ–ª–æ—Å–∞: ${votesCount}`;
    right.appendChild(votesText);

    // –∫–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞
    const btnPick = document.createElement("button");
    btnPick.className = "btn btn-sm btn-outline-light mt-1";
    btnPick.innerText = "–í—ã–±—Ä–∞—Ç—å";
    btnPick.disabled = !p.is_alive;

    btnPick.addEventListener("click", () => {
      selectedTargetId = p.id;
      renderPlayers(players);
    });

    right.appendChild(btnPick);

    row.appendChild(left);
    row.appendChild(right);
    list.appendChild(row);
  });
}



  async function castDayVote(targetId) {
    const form = new FormData();
    form.append("target_id", targetId);

    const r = await post(DAY_VOTE_CAST_URL, form);
    if (r.status !== "success") {
      alert(r.message || "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è");
      return;
    }
    alert("–ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç ‚úÖ");
  }

  function secondsLeft(isoDeadline) {
    if (!isoDeadline) return null;
    const t = new Date(isoDeadline).getTime();
    const now = Date.now();
    const diff = Math.floor((t - now) / 1000);
    return diff;
  }

  function formatSeconds(sec) {
    if (sec === null) return "‚Äî";
    if (sec <= 0) return "0 —Å–µ–∫";
    return `${sec} —Å–µ–∫`;
  }

  function turnRoleLabel(role) {
    const map = {
      "boss": "üíã –ö—Ä–∞—Å–æ—Ç–∫–∞",
      "doctor": "üíâ –î–æ–∫—Ç–æ—Ä",
      "sheriff": "üïµÔ∏è –®–µ—Ä–∏—Ñ",
      "mafia": "üî´ –ú–∞—Ñ–∏—è",
      "maniac": "üî™ –ú–∞–Ω—å—è–∫",
    };
    return map[role] || (role || "‚Äî");
  }

  async function loadState() {
  try {
    const res = await fetch(STATE_URL);
    const json = await res.json();

    if (json.status !== "success") {
      document.getElementById("statusText").innerText = "–û—à–∏–±–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è";
      return;
    }

    // –º–æ–π id (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–≤–µ—Ä—Ö—É!)
    const myId = {{ request.user.id }};

    // –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å"
    currentPhase = json.phase;
    myTurnRole = json.turn_role;
    dayVoteActive = !!json.day_vote_deadline;

    // –±–∞–∑–æ–≤—ã–µ –ø–æ–ª—è
    document.getElementById("playersCount").innerText = json.count ?? 0;
    document.getElementById("dayNumber").innerText = json.day_number ?? 0;
    document.getElementById("nightNumber").innerText = json.night_number ?? 0;

    // –≤–µ–¥—É—â–∏–π
    let hostName = "–Ω–µ—Ç";
    const host = (json.players || []).find(p => p.is_host);
    if (host) hostName = host.name;
    document.getElementById("hostName").innerText = hostName;

    // —Ñ–∞–∑–∞
    document.getElementById("phaseBadge").innerText = phaseLabel(json.phase);

    if (json.game_started) {
      document.getElementById("gameStartedBadge").className = "badge bg-success";
      document.getElementById("gameStartedBadge").innerText = "–ò–≥—Ä–∞ –∏–¥—ë—Ç";
    } else {
      document.getElementById("gameStartedBadge").className = "badge bg-secondary";
      document.getElementById("gameStartedBadge").innerText = "–ò–≥—Ä–∞ –Ω–µ –Ω–∞—á–∞–ª–∞—Å—å";
    }

    // —è –≤ –∫–æ–º–Ω–∞—Ç–µ?
    const inRoom = (json.players || []).some(p => p.id === myId);

    document.getElementById("btnJoin").disabled = inRoom || json.game_started;
    document.getElementById("btnLeave").disabled = !inRoom || json.game_started;

    document.getElementById("btnBecomeHost").disabled =
      !inRoom || json.game_started || (json.host_id !== null);

    // —Å—Ç–∞—Ä—Ç —Ç–æ–ª—å–∫–æ –≤–µ–¥—É—â–∏–π
    document.getElementById("btnStartGame").disabled = (json.host_id !== myId);

    // –º–æ—è —Ä–æ–ª—å (–¢–û–õ–¨–ö–û –ø–æ –º–æ–µ–º—É id!)
    let myRole = "‚Äî";
    myRoleRaw = null;

    const mine = (json.players || []).find(p => p.id === myId);
    if (mine && mine.role) {
      myRole = roleLabel(mine.role);
      myRoleRaw = mine.role;
    }

    document.getElementById("myRole").innerText = myRole;

    // –≥–æ–ª–æ—Å–∞
    window.dayVotes = {};
    if (json.day_votes) {
      for (const k in json.day_votes) {
        window.dayVotes[parseInt(k)] = json.day_votes[k];
      }
    }

    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –º–æ–µ–≥–æ –≤—ã–±–æ—Ä–∞
    if (json.my_day_vote_target_id) {
      selectedTargetId = json.my_day_vote_target_id;
    }

    // –∏–≥—Ä–æ–∫–∏
    renderPlayers(json.players);

    // —Ç–∞–π–º–µ—Ä —Ö–æ–¥–∞
    const turnLeft = secondsLeft(json.action_deadline);
    document.getElementById("turnTimer").innerText = formatSeconds(turnLeft);

    // –∫—Ç–æ —Ö–æ–¥–∏—Ç
    document.getElementById("turnRoleText").innerText = turnRoleLabel(json.turn_role);

    // –¥–µ–¥–ª–∞–π–Ω –¥–Ω–µ–≤–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è
    const dayVoteLeft = secondsLeft(json.day_vote_deadline);
    document.getElementById("dayVoteTimer").innerText = formatSeconds(dayVoteLeft);

    // –¥–µ–¥–ª–∞–π–Ω —Ç–µ–∫—Å—Ç–æ–º
    document.getElementById("dayVoteDeadlineText").innerText = fmtDeadline(json.day_vote_deadline);

    // –ø–æ–±–µ–¥–∏—Ç–µ–ª—å
    if (json.winner_text && json.winner_text !== lastWinnerText) {
      lastWinnerText = json.winner_text;
      alert(json.winner_text);
    }

    document.getElementById("statusText").innerText =
      `–ö–æ–º–Ω–∞—Ç–∞ ${json.room} ‚Ä¢ –ò–≥—Ä–æ–∫–æ–≤: ${json.count} ‚Ä¢ –§–∞–∑–∞: ${phaseLabel(json.phase)}`;

  } catch (e) {
    document.getElementById("statusText").innerText = "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å–æ state()";
  }
}

  async function loadChat() {
    try {
      const res = await fetch(CHAT_LIST_URL);
      const data = await res.json();

      const box = document.getElementById("chatBox");
      box.innerHTML = "";

      if (data.status !== "success") {
        box.innerHTML = `<div class="muted">–ß–∞—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>`;
        return;
      }

      if (!data.messages || data.messages.length === 0) {
        box.innerHTML = `<div class="muted">–ß–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–Ω—ë–º –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç</div>`;
        return;
      }

      data.messages.forEach(m => {
        const div = document.createElement("div");
        div.className = "chat-line";
        div.innerHTML = `
          <span class="chat-time">[${m.time}]</span>
          <b title="${m.full_name || m.user}" style="cursor: help;">${m.user}</b>:
          ${m.text}
        `;
        box.appendChild(div);
      });

      box.scrollTop = box.scrollHeight;
    } catch (e) {
      console.log("chat load error", e);
    }
  }

  async function sendChat() {
    const text = document.getElementById("chatInput").value.trim();
    if (!text) return;

    const form = new FormData();
    form.append("text", text);

    const r = await post(CHAT_SEND_URL, form);

    if (r.status !== "success") {
      document.getElementById("chatStatus").innerText = r.message || "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏";
      return;
    }

    document.getElementById("chatInput").value = "";
    document.getElementById("chatStatus").innerText = "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ";
    await loadChat();
  }

  async function setPhase(phase) {
    const form = new FormData();
    form.append("phase", phase);

    const r = await post(PHASE_SET_URL, form);
    if (r.status !== "success") alert(r.message || "–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ñ–∞–∑—ã");

    await loadState();
    await loadChat();
  }

  // events
  document.getElementById("btnJoin").addEventListener("click", async () => {
    const r = await post(JOIN_URL);
    if (r.status !== "success") alert(r.message || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
    await loadState();
  });

  document.getElementById("btnLeave").addEventListener("click", async () => {
    const r = await post(LEAVE_URL);
    if (r.status !== "success") alert(r.message || "–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞");
    await loadState();
  });

  document.getElementById("btnBecomeHost").addEventListener("click", async () => {
    const r = await post(BECOME_HOST_URL);
    if (r.status !== "success") alert(r.message || "–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –≤–µ–¥—É—â–µ–≥–æ");
    await loadState();
  });

  document.getElementById("btnStartGame").addEventListener("click", async () => {
    const r = await post(START_URL);
    if (r.status !== "success") alert(r.message || "–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã");
    await loadState();
  });

  document.getElementById("btnSetDay").addEventListener("click", () => setPhase("day"));
  document.getElementById("btnSetNight").addEventListener("click", () => setPhase("night"));

  document.getElementById("chatSendBtn").addEventListener("click", sendChat);
  document.getElementById("chatInput").addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendChat();
  });

  document.getElementById("btnStartDayVote").addEventListener("click", async () => {
    const r = await post(DAY_VOTE_START_URL);
    if (r.status !== "success") {
      alert(r.message || "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è");
      return;
    }
    alert("–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ! üó≥");
    await loadState();
  });

  // polling
  loadState();
  loadChat();
  setInterval(loadState, 1500);
  setInterval(loadChat, 1200);

  // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ç–∞–π–º–µ—Ä
  setInterval(() => {
    const turnTimerEl = document.getElementById("turnTimer");
    const dayVoteTimerEl = document.getElementById("dayVoteTimer");

    const parseSec = (txt) => {
      const m = (txt || "").match(/(\d+)/);
      return m ? parseInt(m[1]) : null;
    };

    let s1 = parseSec(turnTimerEl.innerText);
    if (s1 !== null && s1 > 0) turnTimerEl.innerText = `${s1 - 1} —Å–µ–∫`;

    let s2 = parseSec(dayVoteTimerEl.innerText);
    if (s2 !== null && s2 > 0) dayVoteTimerEl.innerText = `${s2 - 1} —Å–µ–∫`;
  }, 1000);

  // ping
  setInterval(async () => {
    try {
      await post(PING_URL);
    } catch (e) {}
  }, 10000);

  console.log("SCRIPT OK");

  document.getElementById("btnDoAction").addEventListener("click", async () => {
  if (!selectedTargetId) {
    alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∏–≥—Ä–æ–∫–∞ üëÜ");
    return;
  }

  // –µ—Å–ª–∏ –∏–¥—ë—Ç –Ω–æ—á—å –∏ —Ö–æ–¥ —Ç–≤–æ–µ–π —Ä–æ–ª–∏ ‚Üí –¥–µ–π—Å—Ç–≤–∏–µ —Ä–æ–ª–∏
  if (currentPhase === "night" && myTurnRole === myRoleRaw) {
    const form = new FormData();
    form.append("target_id", selectedTargetId);

    const r = await post(`/mafia/room/${ROOM_NUMBER}/action/`, form);

    if (r.status !== "success") {
      alert(r.message || "–û—à–∏–±–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è");
      return;
    }

    alert("–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚úÖ");
    selectedTargetId = null;
    await loadState();
    return;
  }

  // –µ—Å–ª–∏ –∏–¥—ë—Ç –¥–Ω–µ–≤–Ω–æ–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ ‚Üí –≥–æ–ª–æ—Å
  if (currentPhase === "day" && dayVoteActive) {
    const form = new FormData();
    form.append("target_id", selectedTargetId);

    const r = await post(`/mafia/room/${ROOM_NUMBER}/day-vote/cast/`, form);

    if (r.status !== "success") {
      alert(r.message || "–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è");
      return;
    }

    alert("–ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç üó≥");
    selectedTargetId = null;
    await loadState();
    return;
  }

  alert("–°–µ–π—á–∞—Å –Ω–µ–ª—å–∑—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å ‚ùå (–Ω–µ —Ç–≤–æ–π —Ö–æ–¥ –∏ –Ω–µ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ)");
});

</script>

</body>
</html>
